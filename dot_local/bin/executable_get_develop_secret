#!/usr/bin/env bash
# NOTE: https://www.grahamwatts.co.uk/gnome-secrets/#how-not-to-do-it

set -euo pipefail

LABEL="KDevelop"
entry="$1"

if [[ -z "$entry" ]]; then
  printf "Usage: %s <entry>\n" "$0"
  exit 1
fi

if [[ "$OSTYPE" == "darwin"* ]]; then
  store_password=$(security find-generic-password -a "$USER" -s "$LABEL" -w || printf "")

  if [[ -z "$store_password" || -n "$FORCE" ]]; then
    store_password=$(zenity --password --title='Unlock KDevelop')
    security add-generic-password -a "$USER" -s "$LABEL" -w "$store_password"
  fi
  echo "$store_password" | /Applications/KeePassXC.app/Contents/MacOS/keepassxc-cli show -a password -s ~/.pwsafe/KDevelop.kdbx "$entry" 2>/dev/null
  exit 0
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
  store_password=$(secret-tool lookup $LABEL passwd)

  if [[ -z "$store_password" || -n "$FORCE" ]]; then
    store_password=$(zenity --password --title='Unlock KDevelop')
    echo "$store_password" | secret-tool store --label=$LABEL $LABEL passwd
  fi
  echo "$store_password" | keepassxc-cli show -a password -s ~/.pwsafe/KDevelop.kdbx "$entry" 2>/dev/null
fi
